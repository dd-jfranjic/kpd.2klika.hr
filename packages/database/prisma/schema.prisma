// ===========================================
// KPD 2klika - Prisma Schema
// Version: 2.1 (GDPR Compliance)
// Date: 2025-12-17
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================
// CORE MULTI-TENANT MODELS
// =====================================

model Organization {
  id                String   @id @default(cuid())
  name              String   // "Tvrtka d.o.o." ili "Ivan's Workspace"
  slug              String   @unique // URL-friendly: "tvrtka-doo"

  // Stripe Integration
  stripeCustomerId  String?  @unique

  // Settings (sve u bazi, nista hardkodirano!)
  settings          Json     @default("{}")

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  members           OrganizationMember[]
  subscription      Subscription?
  usageRecords      UsageRecord[]
  invitations       Invitation[]
  purchases         Purchase[]   // Added 2025-12-19

  @@index([stripeCustomerId])
}

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  passwordHash      String

  // Profile
  firstName         String?
  lastName          String?
  avatarUrl         String?

  // Role (za SUPER_ADMIN pristup admin panelu)
  role              UserRole @default(MEMBER)

  // Status
  isActive          Boolean  @default(true)
  emailVerified     Boolean  @default(false)
  lastLoginAt       DateTime?

  // SECURITY: Account lockout nakon neuspjelih pokušaja
  failedLoginAttempts Int      @default(0)
  lockedUntil         DateTime?

  // GDPR: Registration metadata (nullable for backward compat)
  registrationIp      String?
  registrationAgent   String?
  dataExportedAt      DateTime?  // Last data export timestamp
  deletionRequestedAt DateTime?  // Pending deletion date

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  memberships       OrganizationMember[]
  sentInvitations   Invitation[]
  auditLogs         AuditLog[]
  refreshTokens     RefreshToken[]

  // GDPR Relations
  consents            UserConsent[]
  gdprRequests        GdprRequest[]
  processedGdprRequests GdprRequest[] @relation("ProcessedBy")
  cookieConsent       CookieConsent?

  // Notification Relations
  receivedNotifications Notification[] @relation("ReceivedNotifications")
  createdNotifications  Notification[] @relation("CreatedNotifications")

  // Support Relations
  supportThread         SupportThread?

  @@index([email])
}

enum UserRole {
  MEMBER       // Obicni korisnik
  SUPER_ADMIN  // Master admin - pristup /admin/*
}

model OrganizationMember {
  id             String   @id @default(cuid())

  organizationId String
  userId         String

  role           MemberRole @default(MEMBER)
  joinedAt       DateTime   @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

enum MemberRole {
  OWNER    // Kreator workspacea - full control
  ADMIN    // Moze invite/remove membere
  MEMBER   // Standardni pristup
}

// =====================================
// INVITATION SYSTEM
// =====================================

model Invitation {
  id             String   @id @default(cuid())
  email          String
  token          String   @unique @default(cuid())

  organizationId String
  invitedById    String
  role           MemberRole @default(MEMBER)

  status         InvitationStatus @default(PENDING)
  expiresAt      DateTime
  acceptedAt     DateTime?

  createdAt      DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedBy      User         @relation(fields: [invitedById], references: [id])

  @@index([email])
  @@index([token])
  @@index([organizationId])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

// =====================================
// SUBSCRIPTION & BILLING
// =====================================

model Subscription {
  id                    String   @id @default(cuid())
  organizationId        String   @unique

  // Stripe IDs
  stripeSubscriptionId  String?  @unique
  stripePriceId         String?

  // Plan Details
  plan                  PlanType @default(FREE)
  status                SubscriptionStatus @default(ACTIVE)

  // Billing Type (Added 2025-12-19)
  billingType           BillingType @default(SUBSCRIPTION)

  // Billing Cycle
  currentPeriodStart    DateTime?
  currentPeriodEnd      DateTime?
  cancelAtPeriodEnd     Boolean  @default(false)

  // Usage Limits (iz PlanConfig)
  dailyQueryLimit       Int      @default(5)
  monthlyQueryLimit     Int?     // null = unlimited

  // Bonus Query Quota (Added 2025-12-19) - Kupljeni upiti koji NE RESETIRAJU se mjesečno
  bonusQueryQuota       Int      @default(0)

  // Timestamps
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([stripeSubscriptionId])
  @@index([plan])
}

enum PlanType {
  FREE        // KPD Starter: 0€, 3 upita/mjesec
  BASIC       // KPD Basic: 6.99€, 10 upita/mjesec
  PRO         // KPD Pro: 11.99€, 20 upita/mjesec
  BUSINESS    // KPD Business: 30.99€, 50 upita/mjesec
  ENTERPRISE  // KPD Enterprise: 199€, 2500 upita/mjesec
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  TRIALING
  PAUSED
}

// =====================================
// ONE-TIME BILLING ENUMS (Added 2025-12-19)
// =====================================

enum BillingType {
  SUBSCRIPTION  // Mjesečna pretplata (recurring)
  ONE_TIME      // Jednokratna kupnja
}

enum PurchaseType {
  ONE_TIME_PLAN   // Jednokratni paket (BASIC/PRO/BUSINESS/ENTERPRISE)
  QUERY_BOOSTER   // Dodatni upiti (10 za 6.99 EUR)
  MANUAL_GRANT    // Admin dodijelio besplatno
}

enum PurchaseStatus {
  PENDING     // Čeka plaćanje
  COMPLETED   // Plaćeno i primijenjeno
  REFUNDED    // Vraćen novac
}

// =====================================
// ONE-TIME PURCHASES (Added 2025-12-19)
// =====================================

model Purchase {
  id                      String         @id @default(cuid())
  organizationId          String

  // Stripe veza
  stripePaymentIntentId   String?        @unique
  stripeCheckoutSessionId String?

  // Produkt info
  productType             PurchaseType
  productName             String
  priceEur                Float

  // Benefit
  queriesIncluded         Int

  // Status
  status                  PurchaseStatus @default(PENDING)
  purchasedAt             DateTime?
  refundedAt              DateTime?
  refundReason            String?

  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt

  organization            Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
  @@index([productType])
}

// =====================================
// USAGE TRACKING
// =====================================

model UsageRecord {
  id             String   @id @default(cuid())
  organizationId String

  // Period
  periodStart    DateTime
  periodEnd      DateTime

  // Counters
  queryCount     Int      @default(0)
  aiQueryCount   Int      @default(0)

  // Reset tracking
  lastResetAt    DateTime @default(now())

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, periodStart])
  @@index([organizationId])
  @@index([periodStart])
}

// =====================================
// KPD DATA (Kopirano iz FiskalAI)
// =====================================

model KpdCategory {
  id          String   @id
  name        String
  description String?
  level       Int
  parentId    String?
  isActive    Boolean  @default(true)
  version     String   @default("2025")

  parent      KpdCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    KpdCategory[] @relation("CategoryHierarchy")
  codes       KpdCode[]

  @@index([parentId])
  @@index([level])
}

model KpdCode {
  id          String   @id  // Format: XX.XX.XX
  name        String   @db.VarChar(500)
  description String?
  categoryId  String
  level       Int
  parentId    String?
  fullPath    String?  @db.VarChar(50)
  codeNumeric Int?     // Za sortiranje: 620111 za "62.01.11"
  isFinal     Boolean  @default(false)
  version     String   @default("2025")
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category    KpdCategory @relation(fields: [categoryId], references: [id])
  parent      KpdCode?    @relation("CodeHierarchy", fields: [parentId], references: [id])
  children    KpdCode[]   @relation("CodeHierarchy")
  queries     Query[]

  @@index([categoryId])
  @@index([parentId])
  @@index([level])
  @@index([isFinal, isActive])
  @@index([codeNumeric])
  @@index([name])
}

// =====================================
// QUERY HISTORY & ANALYTICS
// =====================================

model Query {
  id             String   @id @default(cuid())
  organizationId String
  userId         String?

  // Query Details
  inputText      String
  suggestedCodes String[] // Array of KPD codes
  selectedCode   String?  // Kod koji je korisnik odabrao

  // AI Response
  aiModel        String?
  confidence     Float?
  latencyMs      Int?
  cached         Boolean  @default(false)
  explanation    String?  // AI objašnjenje s aspektom (npr. "Ova šifra opisuje... - ASPEKT: PROIZVOD")
  sector         String?  // Sektor (npr. "Sektor C - Prerađivačka industrija")
  suggestionsData Json?   // Puni podaci za SVE predložene šifre [{code, name, confidence, reason, sector}]

  // Context
  ipAddress      String?
  userAgent      String?

  createdAt      DateTime @default(now())

  selectedKpd    KpdCode? @relation(fields: [selectedCode], references: [id])

  @@index([organizationId])
  @@index([userId])
  @@index([createdAt])
}

// =====================================
// SYSTEM CONFIGURATION (SVE U BAZI!)
// =====================================

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  type        ConfigType @default(STRING)
  category    String   @default("general")
  description String?
  isSecret    Boolean  @default(false) // Encrypted in DB

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
}

enum ConfigType {
  STRING
  NUMBER
  BOOLEAN
  JSON
  SECRET  // AES-256 encrypted
}

model PlanConfig {
  id                   String   @id @default(cuid())
  plan                 PlanType @unique

  // Pricing - Monthly Subscription
  monthlyPriceEur      Float
  stripePriceId        String?
  stripeProductId      String?

  // Pricing - One-Time Purchase (Added 2025-12-19)
  oneTimePriceEur      Float?            // null = same as monthly
  stripeOneTimePriceId String?

  // Limits
  dailyQueryLimit      Int
  monthlyQueryLimit    Int?     // null = unlimited
  membersLimit         Int?     // null = unlimited

  // Features (JSON za fleksibilnost)
  features             Json     @default("[]")

  // Display
  displayName          String
  description          String?
  isPopular         Boolean  @default(false)
  sortOrder         Int      @default(0)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// =====================================
// API KEYS (For programmatic access)
// =====================================

model ApiKey {
  id             String   @id @default(cuid())
  organizationId String

  name           String   // User-friendly name: "Production API Key"
  keyHash        String   // SHA-256 hash of the key (never store plaintext!)
  keyPrefix      String   // First 8 chars for identification: "kpd_xxxx"

  // Permissions & Status
  scopes         String[] @default(["classify:read"]) // classify:read, classify:write, etc.
  isActive       Boolean  @default(true)

  // Usage tracking
  lastUsedAt     DateTime?
  usageCount     Int      @default(0)

  // Expiration
  expiresAt      DateTime?

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@index([keyHash])
  @@index([keyPrefix])
}

// =====================================
// AUDIT LOG (Admin akcije)
// =====================================

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?  // SUPER_ADMIN koji je napravio akciju

  action      String   // CREATE_USER, UPDATE_PLAN, etc.
  entityType  String   // User, Organization, etc.
  entityId    String?

  oldValue    Json?
  newValue    Json?

  ipAddress   String?
  userAgent   String?

  createdAt   DateTime @default(now())

  user        User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// =====================================
// EMAIL TEMPLATES (Admin-editable)
// =====================================

model EmailTemplate {
  id          String   @id @default(cuid())
  type        String   @unique  // VERIFICATION, PASSWORD_RESET, INVITATION, WELCOME
  name        String            // Display name: "Email Verifikacije"
  subject     String            // Email subject line
  content     String   @db.Text // HTML content with {{placeholders}}
  variables   Json     @default("[]") // Available placeholders

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
}

// =====================================
// REFRESH TOKENS (SECURITY)
// =====================================

model RefreshToken {
  id          String   @id @default(cuid())
  userId      String
  tokenHash   String   @unique // SHA-256 hash (never store plaintext!)

  // Device/session info
  userAgent   String?
  ipAddress   String?

  // Status
  isRevoked   Boolean  @default(false)
  expiresAt   DateTime

  // Timestamps
  createdAt   DateTime @default(now())
  lastUsedAt  DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

// =====================================
// GDPR COMPLIANCE
// =====================================

// Consent tracking for registration and other user agreements
model UserConsent {
  id              String      @id @default(cuid())
  userId          String

  // Consent type and details
  consentType     ConsentType
  granted         Boolean     @default(true)
  version         String      @default("1.0") // Policy version (e.g., "1.0", "2.0")

  // Audit trail
  ipAddress       String?
  userAgent       String?

  // Timestamps
  grantedAt       DateTime    @default(now())
  revokedAt       DateTime?

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([consentType])
  @@index([grantedAt])
}

enum ConsentType {
  TERMS_OF_SERVICE      // Uvjeti korištenja - obavezno pri registraciji
  PRIVACY_POLICY        // Politika privatnosti - obavezno pri registraciji
  MARKETING_EMAILS      // Marketing komunikacija - opcionalno
  ANALYTICS_COOKIES     // Analitički kolačići
  MARKETING_COOKIES     // Marketing kolačići
}

// GDPR data requests (export, deletion)
model GdprRequest {
  id              String            @id @default(cuid())
  userId          String

  requestType     GdprRequestType
  status          GdprRequestStatus @default(PENDING)

  // Request details
  reason          String?           // User's reason (for deletion)
  notes           String?           // Admin notes

  // Processing info
  processedById   String?           // Admin who processed
  processedAt     DateTime?

  // For data export
  exportUrl       String?           // Temporary download URL
  exportExpiresAt DateTime?         // Export link expiry (24h)

  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  processedBy     User?             @relation("ProcessedBy", fields: [processedById], references: [id])

  @@index([userId])
  @@index([status])
  @@index([requestType])
  @@index([createdAt])
}

enum GdprRequestType {
  DATA_EXPORT       // Članak 15 - Pravo pristupa podacima
  DATA_DELETION     // Članak 17 - Pravo na brisanje
}

enum GdprRequestStatus {
  PENDING           // Čeka obradu
  PROCESSING        // U obradi
  COMPLETED         // Završeno
  REJECTED          // Odbijeno (s razlogom)
  CANCELLED         // Korisnik odustao
}

// Cookie consent for visitors (may or may not be logged in)
model CookieConsent {
  id              String      @id @default(cuid())

  // Visitor identification
  visitorId       String      @unique  // UUID stored in browser cookie
  userId          String?     @unique  // Link to user if logged in

  // Consent categories
  necessary       Boolean     @default(true)   // Always true, required
  analytics       Boolean     @default(false)  // Google Analytics, etc.
  marketing       Boolean     @default(false)  // Advertising, remarketing

  // Audit
  ipAddress       String?
  userAgent       String?

  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user            User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([visitorId])
  @@index([userId])
}

// =====================================
// NOTIFICATION SYSTEM
// =====================================

model Notification {
  id              String              @id @default(cuid())

  // Recipient (null = broadcast to all)
  recipientId     String?
  recipient       User?               @relation("ReceivedNotifications", fields: [recipientId], references: [id], onDelete: Cascade)

  // Broadcast flag (if true, goes to all users)
  isBroadcast     Boolean             @default(false)

  // Content
  kind            NotificationKind    @default(CLASSIC)
  title           String
  body            String?

  // Metadata (e.g., gift amount, link, etc.)
  metadata        Json?

  // Created by admin
  createdById     String
  createdBy       User                @relation("CreatedNotifications", fields: [createdById], references: [id])

  // Status tracking
  readAt          DateTime?           // For CLASSIC - when marked as read
  shownAt         DateTime?           // For LOGIN_POPUP - when shown to user
  expiresAt       DateTime?           // Optional expiry

  createdAt       DateTime            @default(now())

  @@index([recipientId])
  @@index([isBroadcast])
  @@index([kind])
  @@index([createdAt])
}

enum NotificationKind {
  CLASSIC       // Bell icon, notification center
  LOGIN_POPUP   // Modal popup on login (show once)
}

// =====================================
// SUPPORT CHAT SYSTEM
// =====================================

model SupportThread {
  id              String              @id @default(cuid())

  // One thread per user (WhatsApp style)
  userId          String              @unique
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Status
  status          ThreadStatus        @default(OPEN)

  // Tracking
  lastMessageAt   DateTime?
  unreadByAdmin   Int                 @default(0)
  unreadByUser    Int                 @default(0)

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  messages        SupportMessage[]

  @@index([status])
  @@index([lastMessageAt])
}

enum ThreadStatus {
  OPEN
  CLOSED
  ARCHIVED
}

model SupportMessage {
  id              String              @id @default(cuid())

  threadId        String
  thread          SupportThread       @relation(fields: [threadId], references: [id], onDelete: Cascade)

  // Sender
  senderType      SenderType
  senderId        String              // User ID (both user and admin are Users)

  // Content
  body            String

  // Status
  readAt          DateTime?

  createdAt       DateTime            @default(now())

  @@index([threadId])
  @@index([createdAt])
}

enum SenderType {
  USER
  ADMIN
}
